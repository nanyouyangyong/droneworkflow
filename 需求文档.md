无人机智能工作流系统 - 需求文档
# 1. 系统概述
## 1.1 项目简介
基于LangGraph.js的无人机智能工作流编排系统，通过自然语言交互自动生成并执行无人机工作流，实现任务编排、自动化执行和实时监控的一体化管理。

## 1.2 技术架构
前端：Next.js 15 + ReactFlow + Zustand + TailwindCSS

后端：Node.js + LangGraph.js + MongDB + Express/Next.js API Routes

通信：WebSocket + REST API

LLM集成：支持OpenAI GPT-4/Claude 3.5/Local LLMs

## 2. 界面布局与功能模块
### 2.1 四栏布局设计
text
┌────────────────┬────────────────┬────────────────┬────────────────┐
│  左侧：        │  左中：        │  右中：        │  右侧：        │
│  大模型对话框  │  指令历史记录  │  工作流画布    │  执行日志      │
│  (400px)       │  (300px)       │  (自适应)      │  (400px)       │
└────────────────┴────────────────┴────────────────┴────────────────┘
### 2.2 各模块详细说明
#### A. 大模型对话框（左侧面板）

typescript
// 功能组件结构
interface ChatPanel {
  features: {
    // 1. 多模型支持切换
    modelSelector: ['gpt-4', 'claude-3.5', 'deepseek-coder', 'local-llm'],
    
    // 2. 对话输入区域
    messageInput: {
      placeholder: "描述你的无人机任务，如：'巡查A区域并拍照，电量低于30%时返航'",
      supportAttachments: true,  // 支持上传地图、任务区域图
      voiceInput: false,         // 二期功能
    },
    
    // 3. 对话历史显示
    conversation: {
      format: "用户指令 → LLM解析 → 工作流生成确认",
      maxTokens: 4000,
    },
    
    // 4. 快捷指令模板
    templates: [
      "区域巡检模板",
      "紧急搜救模板", 
      "农业监测模板",
      "设施巡查模板"
    ]
  }
}
B. 指令历史记录（左中面板）

typescript
interface HistoryPanel {
  features: {
    // 1. 时间线展示
    timelineView: {
      groupBy: ['今天', '昨天', '更早'],
      statusBadges: ['生成成功', '执行中', '已完成', '失败'],
    },
    
    // 2. 历史记录项
    historyItem: {
      fields: [
        '时间戳',
        '原始指令',
        '工作流节点数', 
        '执行状态',
        '快捷操作: [重新执行] [复制为模板] [查看详情]'
      ]
    },
    
    // 3. 筛选与搜索
    filters: {
      dateRange: true,
      statusFilter: true,
      keywordSearch: true,
    }
  }
}
C. 工作流画布（右中面板）

typescript
// ReactFlow工作流配置
const workflowCanvasConfig = {
  // 1. 节点库分类侧边栏
  nodePalette: {
    categories: [
      {
        name: '任务规划',
        nodes: ['区域定义', '航线生成', '航点设置', '任务优先级']
      },
      {
        name: '设备控制', 
        nodes: ['起飞/降落', '设置高度', '调整速度', '控制云台']
      },
      {
        name: '数据采集',
        nodes: ['定时拍照', '视频录制', '传感器读取', '实时图传']
      },
      {
        name: '条件逻辑',
        nodes: ['电量检查', '天气判断', '避障决策', '异常处理']
      },
      {
        name: '数据处理',
        nodes: ['图像分析', '数据聚合', '报告生成', '警报触发']
      }
    ],
    dragAndDrop: true
  },
  
  // 2. 画布交互功能
  canvasFeatures: {
    zoom: { min: 0.1, max: 2 },
    multiSelect: true,
    snapToGrid: true,
    background: { 
      pattern: 'dots',
      gap: 20 
    }
  },
  
  // 3. 节点样式规范
  nodeStyles: {
    default: { width: 180, height: 80 },
    types: {
      startNode: { color: '#10B981', shape: 'circle' },
      actionNode: { color: '#3B82F6', shape: 'rectangle' },
      conditionNode: { color: '#F59E0B', shape: 'diamond' },
      endNode: { color: '#EF4444', shape: 'circle' }
    }
  }
}
D. 执行日志面板（右侧面板）

typescript
interface LogPanel {
  display: {
    // 1. 多标签页设计
    tabs: ['实时日志', '节点详情', '性能监控', '错误报告'],
    
    // 2. 日志级别
    logLevels: {
      info: '#6B7280',
      success: '#10B981', 
      warning: '#F59E0B',
      error: '#EF4444',
      debug: '#8B5CF6'
    },
    
    // 3. 实时更新
    realtime: {
      websocket: true,
      autoScroll: true,
      pauseButton: true
    }
  },
  
  // 4. 关键指标展示
  metrics: [
    '工作流执行进度',
    '节点成功率',
    '平均执行时间',
    '资源使用率'
  ]
}
# 3. 核心工作流设计
## 3.1 LangGraph.js 状态定义
javascript
// 后端状态模型
const DroneWorkflowState = {
  // 任务状态
  mission: {
    id: 'string',
    name: 'string',
    description: 'string',
    status: ['pending', 'running', 'paused', 'completed', 'failed'],
    progress: 'number', // 0-100
  },
  
  // 无人机状态
  drone: {
    battery: 'number',      // 电量百分比
    position: { lat: 'number', lng: 'number', alt: 'number' },
    speed: 'number',
    mode: ['idle', 'taking_off', 'flying', 'landing', 'emergency'],
    camera: { is_recording: 'boolean', last_capture: 'timestamp' }
  },
  
  // 工作流执行状态
  execution: {
    currentNode: 'string',
    visitedNodes: 'array',
    nextNodes: 'array',
    errors: 'array',
    startTime: 'timestamp',
    estimatedCompletion: 'timestamp'
  },
  
  // 数据收集
  data: {
    images: 'array',
    sensorReadings: 'array',
    analysisResults: 'object'
  }
}
## 3.2 关键节点实现示例
javascript
// 1. 自然语言解析节点
const parseInstructionNode = async (state) => {
  const prompt = `
    将用户指令解析为无人机工作流节点：
    指令: "${state.userInput}"
    
    请按以下JSON格式输出:
    {
      "workflow_name": "任务名称",
      "nodes": [
        { "type": "区域定义", "params": {...} },
        { "type": "航线规划", "params": {...} },
        ...
      ],
      "edges": [
        { "from": "节点1", "to": "节点2", "condition": null },
        ...
      ]
    }
  `;
  
  const llmResponse = await callLLM(prompt);
  return { 
    ...state, 
    parsedWorkflow: JSON.parse(llmResponse),
    currentNode: 'workflow_generated'
  };
};

// 2. 电量检查条件节点
const batteryCheckNode = async (state) => {
  const { drone } = state;
  
  if (drone.battery < 20) {
    return {
      ...state,
      nextAction: 'emergency_landing',
      log: '电量低于20%，触发紧急返航'
    };
  } else if (drone.battery < 40) {
    return {
      ...state,
      nextAction: 'return_to_base',
      log: '电量低于40%，计划返航'
    };
  }
  
  return { ...state, nextAction: 'continue_mission' };
};
## 3.3 前后端数据流
text
前端交互流程：
1. 用户输入指令 → 2. 发送到Next.js API → 3. 调用LLM解析 → 
4. 生成初始工作流 → 5. 返回给前端ReactFlow → 6. 用户调整确认 →
7. 发送执行请求 → 8. LangGraph引擎执行 → 9. WebSocket实时推送 →
10. 前端四栏同步更新
# 4. 开发实施建议
## 4.1 阶段划分
阶段一（1-2周）：搭建四栏基础布局，实现ReactFlow静态画布

阶段二（2-3周）：集成LLM对话，实现指令到基础节点的转换

阶段三（3-4周）：实现LangGraph.js后端引擎，建立WebSocket连接

阶段四（1-2周）：完善节点库，添加异常处理和日志系统

## 4. 2 关键依赖包
json
{
  "frontend": {
    "next": "^15.x",
    "react": "^19.x",
    "reactflow": "^11.x",
    "zustand": "^4.x",
    "tailwindcss": "^3.x",
    "socket.io-client": "^4.x"
  },
  "backend": {
    "@langchain/langgraph": "^0.2.x",
    "@langchain/openai": "^0.3.x",
    "express": "^4.x",
    "socket.io": "^4.x",
    "uuid": "^9.x"
  }
}
## 4.3 注意事项
状态同步：使用Zustand管理应用状态，ReactFlow管理画布状态，两者需保持同步

错误边界：每个LangGraph节点需要独立的错误处理，避免单点故障影响整个工作流

性能优化：工作流复杂时，考虑节点懒加载和可视化聚合

安全性：无人机控制指令需要严格的权限验证和操作确认